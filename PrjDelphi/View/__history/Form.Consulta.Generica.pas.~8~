unit Form.Consulta.Generica;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.Grids, Vcl.DBGrids, Data.FMTBcd, Data.SqlExpr, System.Actions,
  Vcl.ActnList, Vcl.Buttons, Vcl.ComCtrls,
  Controller.Usuario,
  Uteis;

type
  TAbrirConsulta = class
    private
    public
    class function AbrirConsultaUsuario(edtCodUsuario: TLabeledEdit; edtNomeUsuario, edtSenha: TEdit; cmbDireitos: TComboBox; SQLWhere: String): String;
    class function AbrirConsultaUsuarioTarefa(edtCodUsuario: TLabeledEdit; edtNomeUsuario: TEdit; SQLWhere: String): String;
    class function AbrirConsultaTarefa(edtCodUsuario: TLabeledEdit; edtNomeUsuario: TEdit; SQLWhere: String): String;
  end;

type
  TFrmConsultaGenerica = class(TForm)
    dbgConsulta: TDBGrid;
    Panel1: TPanel;
    dsConsulta: TDataSource;
    ActionList1: TActionList;
    StatusBar1: TStatusBar;
    btnSair: TBitBtn;
    btnSelecionar: TBitBtn;
    actSelecionar: TAction;
    actSair: TAction;
    procedure actSairExecute(Sender: TObject);
    procedure actSelecionarExecute(Sender: TObject);
    procedure dbgConsultaDblClick(Sender: TObject);
    procedure dbgConsultaKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure FormShow(Sender: TObject);
    procedure FormResize(Sender: TObject);
  private
    { Private declarations }
    FCodUsu: Integer;
    FConsultar: boolean;
  public
    { Public declarations }

  end;

var
  FrmConsultaGenerica: TFrmConsultaGenerica;

implementation

{$R *.dfm}


{ TfrmConsulta }

class function TAbrirConsulta.AbrirConsultaUsuarioTarefa(edtCodUsuario: TLabeledEdit; edtNomeUsuario: TEdit; SQLWhere: String): String;
begin
  try
    try
      Application.CreateForm(TFrmConsultaGenerica, FrmConsultaGenerica);

      VPSQL:= 'SELECT CODIGO, NOME FROM USUARIOS ';

      ControllerUsuario.ConsultarUsuarios(VPSQL + SQLWhere);


      FrmConsultaGenerica.Caption:= 'Consultar Usuários';
      FrmConsultaGenerica.ShowModal;

      if (FCodUsu <> 0) then
      begin
        if (edtCodUsuario <> nil) then
          edtCodUsuario.Text  := ControllerUsuario.cdsConsulta.FieldByName('CODIGO').AsString;

        if (edtNomeUsuario <> nil) then
          edtNomeUsuario.Text  := ControllerUsuario.cdsConsulta.FieldByName('NOME').AsString;

        FConsultar:= (edtCodUsuario = nil) and (edtCodUsuario = nil) and (SQLWhere = '');
      end;
    except on E: Exception do
      MsgErroCriacao(FrmConsultaGenerica);
    end;
  finally
    FreeAndNil(FrmConsultaGenerica);
  end;
end;

class function TAbrirConsulta.AbrirConsultaTarefa(edtCodUsuario: TLabeledEdit; edtNomeUsuario: TEdit;
  SQLWhere: String): String;
begin
   try
    try
      Application.CreateForm(TFrmConsultaGenerica, FrmConsultaGenerica);

      VPSQL:= ' SELECT T.CODIGO, T.NOME,                                   ' +
             '        CASE WHEN T.TIPO = 0 then ''Diário''                ' +
             '             WHEN T.TIPO = 1 then ''Semanal''               ' +
             '             WHEN T.TIPO = 2 then ''Quinzenal''             ' +
             '             WHEN T.TIPO = 3 then ''Mensal''                ' +
             '        END TIPO                                            ' +
             ' FROM TAREFAS T ' +
             ' INNER JOIN USUARIO_TAREFA UT ON UT.COD_TAREFA = T.CODIGO   ' ;

      ControllerUsuario.ConsultarUsuarios(VPSQL + SQLWhere);

      if (ControllerUsuario.cdsConsulta.IsEmpty) then
      begin
        ShowMessage('A busca não retornou registros!');
        Exit;
      end;

      FrmConsultaGenerica.Caption:= 'Consultar Tarefas';
      FrmConsultaGenerica.ShowModal;

      if (FCodUsu <> 0) then
      begin
        if (edtCodUsuario <> nil) then
          edtCodUsuario.Text  := ControllerUsuario.cdsConsulta.FieldByName('CODIGO').AsString;

        if (edtNomeUsuario <> nil) then
          edtNomeUsuario.Text := ControllerUsuario.cdsConsulta.FieldByName('NOME').AsString;;

        FConsultar:= (edtCodUsuario = nil) and (edtNomeUsuario = nil) and (SQLWhere = '');
      end;
    except on E: Exception do
      MsgErroCriacao(FrmConsultaGenerica);
    end;
  finally
    FreeAndNil(FrmConsultaGenerica);
  end;
end;

class function TAbrirConsulta.AbrirConsultaUsuario(edtCodUsuario: TLabeledEdit; edtNomeUsuario, edtSenha: TEdit; cmbDireitos: TComboBox; SQLWhere: String): String;
begin
  try
    try
      Application.CreateForm(TFrmConsultaGenerica, FrmConsultaGenerica);

      VPSQL:= 'SELECT CODIGO, NOME, SENHA, DIREITO, CASE WHEN DIREITO = 0 THEN ''SUPERVISOR'' ELSE ''OPERADOR'' END DIREITO_DESCRICAO FROM USUARIOS ';

      ControllerUsuario.ConsultarUsuarios(VPSQL + SQLWhere);

      if (ControllerUsuario.cdsConsulta.IsEmpty) then
      begin
        ShowMessage('A busca não retornou registros!');
        Exit;
      end;

      FrmConsultaGenerica.Caption:= 'Consultar Usuários';
      FrmConsultaGenerica.ShowModal;

      if (FCodUsu <> 0) or (ControllerUsuario.cdsConsulta.FieldByName('NOME').AsString = 'ADM') then
      begin
        if (edtCodUsuario <> nil) then
          edtCodUsuario.Text  := ControllerUsuario.cdsConsulta.FieldByName('CODIGO').AsString;

        if (edtNomeUsuario <> nil) then
          edtNomeUsuario.Text := ControllerUsuario.cdsConsulta.FieldByName('NOME').AsString;

        if (edtSenha <> nil) then
          edtSenha.Text := ControllerUsuario.cdsConsulta.FieldByName('SENHA').AsString;

        if (cmbDireitos <> nil) then
          cmbDireitos.ItemIndex := ControllerUsuario.cdsConsulta.FieldByName('DIREITO').AsInteger;

        SUPERVISOR:= ControllerUsuario.cdsConsulta.FieldByName('DIREITO_DESCRICAO').AsString = 'SUPERVISOR';

        FConsultar:= (edtCodUsuario = nil) and (edtNomeUsuario = nil) and (SQLWhere = '');
      end;
    except on E: Exception do
      MsgErroCriacao(FrmConsultaGenerica);
    end;
  finally
    FreeAndNil(FrmConsultaGenerica);
  end;
end;

procedure TFrmConsultaGenerica.FormResize(Sender: TObject);
begin
 AjustarColunas(dbgConsulta);
end;

procedure TFrmConsultaGenerica.FormShow(Sender: TObject);
begin
  if (FConsultar) then
    btnSelecionar.Enabled:= False;
end;

procedure TFrmConsultaGenerica.actSairExecute(Sender: TObject);
begin
  FCodUsu:= 0;
  Self.Close;
end;

procedure TFrmConsultaGenerica.actSelecionarExecute(Sender: TObject);
begin
  if not(dbgConsulta.DataSource.DataSet.IsEmpty) then
  begin
    FCodUsu:= dbgConsulta.DataSource.DataSet.FieldByName('CODIGO').AsInteger;
    Close;
  end;
end;

procedure TFrmConsultaGenerica.dbgConsultaDblClick(Sender: TObject);
begin
  actSelecionarExecute(nil);
end;

procedure TFrmConsultaGenerica.dbgConsultaKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (Key = VK_RETURN) then
    actSelecionarExecute(nil);

  if (Key = VK_ESCAPE) then
    actSairExecute(nil);
end;

end.
